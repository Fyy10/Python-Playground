# UNIX读书笔记

## 第一章 绪论

这一章介绍了计算机硬件和软件的一些基本知识。

计算机：可以存储和处理数据的可编程电子设备

计算机硬件：

- 处理器单元
- 内存
- 外存
- 输入设备
- 输出设备

## 第二章 UNIX操作系统

这一章介绍UNIX的发展历史，基本当看故事了。

Linux不是UNIX (Linux is not UNIX)

### Unix主要特性

- 可移植性
  - 运行在各种类型的计算机上，支持不同硬件

- 多用户性能

  - 多用户同时共享计算机资源

- 多任务性能

  - 允许多个任务同时运行（前台、后台）

- 分级文件系统

  - 采用树状目录组织文件，顶级是/目录

- 与设备独立的输入输出操作

  - UNIX将所有设备当作文件处理，采用通用输入输出命令

- 用户界面（Shell）

  - 用户与系统的接口，是一种命令解释程序

  - shell脚本

- 系统工具

  - 文本编辑，系统管理

## 第三章 UNIX入门

### 登入登出

通过用户名和密码登入

在命令行输入`exit`或`ctrl-d`登出

通过`passwd`修改密码，屏幕上不会显示密码，需要两次输入新密码，新旧密码至少3个字符不同，长度至少6字符，至少2个字母1个数字，密码不能与用户名相同

### 基本命令格式

命令分成三部分

- 命令名
- 命令选项
- 命令参数

```shell
# 命令大小写敏感，只接受小写命令名
命令 [-命令选项] [命令参数]
```

### 一些简单的命令

#### date

显示当前日期和时间

#### who

列出当前系统登入的所有用户登录信息

who的选项

- \-q：显示简要信息，仅用户名和用户数
- \-H：显示各列信息的标题
- \-b：显示系统启动日期和时间
- \-s：只显示用户名，终端号和登陆时间
- who am i：显示执行这条语句的用户的登陆信息

#### cal

显示当前月的日历

可以指定年月

```shell
cal 3 2020
```

#### man

查阅UNIX系统内部自带的手册，很常用，在手册中按h可以查看手册的使用说明，按q退出，翻页操作类似于vim

手册是分页的，可以通过`man man`查看各个分页所包含的内容

##### man分卷

1. 可执行程序和shell命令
2. 系统调用（内核提供的函数）
3. 库调用（函数库提供的函数）
4. 特殊文件（通常位于/dev）
5. 文件格式和规范
6. 游戏
7. 杂项
8. 系统管理命令
9. 内核例程

### Shell

在字符界面中与用户进行交互

shell种类：

- sh
- ksh
- csh
- bash
- dash

可以使用`chsh`改变登陆的缺省shell

`ctrl-u`可以删除当前输入的整行命令

`ctrl+d`可以退出登陆

`ctrl+h`退格（感觉跟backspace没有什么区别）

### 登录过程

UNIX启动后，init为每个终端激活一个getty，getty再分别执行login程序，login判断用户密码正确后，执行shell，当用户从shell登出，init会重新为终端激活一个getty，等待下一次登入。（而现在很多Linux发行版选择使用systemd而不是init）

## 第四章 vim

字符界面文本编辑器

- vi/vim
- emacs
- nano

### vim工作模式

- 命令模式
- 插入模式
- 命令行模式
- visual模式

默认进入的是命令模式，按：进入命令行模式，在命令模式中按如下键可以进入插入模式（常见的编辑模式）：

- i：在光标前插入
- I：在光标所在行首插入
- a：在光标后插入
- A：在光标所在行尾插入
- o：在光标所在行下面新建一行插入
- O：在光标所在行上面新建一行插入

使用`Esc`从插入模式退回到命令模式

### vim基本命令

在打开文件的时候添加`-R`选项可以以只读方式打开，添加`-c`选项可以执行命令行模式的命令

```shell
# 在tmp.sql中查询CREATE字符串
vim -c/CREATE tmp.sql
```

| 键   | 功能                                 |
| ---- | ------------------------------------ |
| x    | 从指定位置开始删除字符               |
| dd   | 删除整行                             |
| u    | 放弃最近修改                         |
| U    | 放弃对当前行的所有修改               |
| r    | 替换光标所在的字符                   |
| R    | 从当前光标开始替换字符，进入插入模式 |
| .    | 重复上次修改                         |
| ZZ   | 保存文件并退出                       |

| 常用快捷键              | 功能                                      |
| ----------------------- | ----------------------------------------- |
| ctrl+f                  | 下一页（forward）                         |
| ctrl+b                  | 上一页（backward）                        |
| ctrl+d                  | 向下半页（down）                          |
| ctrl+u                  | 向上半页（up）                            |
| 0                       | 数字0，移动到本行最前面                   |
| $                       | 移动到本行最后面                          |
| G                       | 移动到最后一行                            |
| nG                      | n为数字，移动到第n行                      |
| gg                      | 移动到第一行                              |
| nEnter                  | n为数字，向下n行                          |
| /word                   | 向下寻找word                              |
| ?word                   | 向前寻找word                              |
| n                       | 继续查找（next）                          |
| N                       | 与n相反，反向查找                         |
| :n1, n2 s/word1/word2/g | 将n1行到n2行间的word1替换为word2          |
| :n1, $ s/word1/word2/gc | 从n1行到末尾替换，每次confirm             |
| x, X                    | 删除，x向后（delete），X向前（backspace） |
| dd                      | 删除光标所在那一行                        |
| ndd                     | 删除下面n行                               |
| yy                      | 复制当前行                                |
| nyy                     | 复制下面n行                               |
| p                       | 粘贴（paste）                             |
| u                       | 撤销（undo）                              |
| ctrl+r                  | 重做（redo）                              |
| .                       | 小数点，重复上次操作                      |
| :! 命令                 | 暂时退出到命令行执行命令                  |

vim区块（visual block）选择

| 快捷键 | 功能                         |
| ------ | ---------------------------- |
| v      | 字符选择，选择光标经过的字符 |
| V      | 行选择，选择光标经过的行     |
| ctrl+v | 区块选择（矩形）             |
| y      | 复制选择区                   |
| d      | 删除选择区                   |

vim多文件编辑

| 命令   | 功能                   |
| ------ | ---------------------- |
| :n     | 编辑下一个文件         |
| :N     | 编辑上一个文件         |
| :files | 列出所有正在编辑的文件 |

vim多窗口编辑

| 命令          | 功能                                 |
| ------------- | ------------------------------------ |
| :sp 文件名    | 开启（separate）新窗口，文件名可缺省 |
| ctrl+w+上下键 | 切换窗口（window）                   |
| ctrl+w+q      | 关闭当前窗口（quit）                 |
| :vsp 文件名   | 按垂直方向拆分窗口                   |
| ctrl+w+左右键 | 左右切换窗口                         |

## 第五章 UNIX文件系统

### 磁盘与文件

文件是操作系统对io设备的抽象，进程/线程是对执行过程的抽象

文件：

- 普通文件（规则文件）：文本、脚本、程序等
- 目录文件：UNIX中的目录是当文件看待的
- 特殊文件：io设备等

### 重要目录

- /：根目录
- /usr：用户目录
  - /usr/include：各种库的头文件
  - /usr/bin：用户可执行文件
  - /usr/local：自行编译安装目录
- /root：管理员目录
- /boot：系统自举目录
- /bin：可执行文件
- /dev：设备文件
- /sbin：管理程序
- /etc：配置文件
- /home：用户目录
- /var：经常变动的文件

### 路径

以/开头的路径为绝对路径，否则为相对路径

### 目录相关命令

#### pwd

打印当前工作目录（print working directory）

#### cd

改变当前目录（change directory）

- cd：回到主目录
- cd 路径：进入路径目录

#### mkdir

创建目录

- mkdir 目录名
- mkdir -p 目录名：可以一次性创建目录及其子目录

#### rmdir

删除目录（空目录无法删除）

也可以用`rm -r 目录名`

#### ls

打印当前目录的子目录及文件

常用选项如下：

| 短选项 | 长选项                 | 功能                       |
| ------ | ---------------------- | -------------------------- |
| -a     | --all                  | 列出所有文件，包括隐藏文件 |
| -l     | --format=single-column | 详细列出文件属性           |
| -r     | --reverse              | 反字母顺序列出文件         |
| -R     | --recursive            | 递归地列出子目录内容       |
| -i     | --inode                | 显示i-node节点             |
| -s     | --size                 | 以文件块为单位显示文件大小 |

文件类型

- -：普通文件
- d：目录
- c：字符设备
- b：块设备
- l：符号连接
- s：套接字

文件权限：

权限包含拥有者权限、组权限和其它权限，rwx分别表示读权限、写权限和执行与访问权限

可以使用`chmod`命令更改文件权限

```shell
# 示例
chmod u+x xxx
chmod g-r xxx
chmod 777 xxx
```

隐藏文件：

用.开头的文件表示隐藏文件，单独的一个.表示当前目录，两个.表示父目录

### 文件操作

`cat`查看文件内容

`touch`创建一个空文件，或者更新已有文件的修改时间

`rm`删除文件

- rm -rf：强制递归删除文件夹
- rm -i：删除前确定

为防止信息滚动过快，可以使用`ctrl+s`进行锁屏，`ctrl+q`恢复（实际上没多少作用）

#### lp

打印命令，把文件发送给打印机

```shell
lp filename1 filename2 ...
```

lp命令选项

| 选项 | 功能                           |
| ---- | ------------------------------ |
| -d   | 在指定打印机上打印             |
| -m   | 完成打印后，向用户邮箱发邮件   |
| -n   | 指定打印份数                   |
| -s   | 取消反馈消息                   |
| -t   | 输出的标题页打印指定标题       |
| -w   | 完成打印后，在用户终端显示消息 |

使用`cancel`命令取消打印请求

使用`lpstat`命令获得打印请求和打印状态的信息

#### pr

实现增强的文件打印功能（格式化打印）

```shell
# 默认每页66行，每页顶部有5行页眉（两行空白，一行文件信息和另外两行空白，信息行包括当前日期和时间、指定文件名和页号），每页底部也留有5行空白
pr myfile
```

以下为pr命令的详细参数及其功能

| 参数       | 功能                                |
| ---------- | ----------------------------------- |
| +page      | 从指定页开始显示。默认第1页         |
| -columns   | 用指定的列数显示输出。默认是1列     |
| -a         | 以横跨页面的方式显示输出，每列一行  |
| -d         | 双倍行距显示输出                    |
| -h std     | 用指定字符串str替代页眉的文件名     |
| -l number  | 用指定的行数设置页长。默认值是66行  |
| -m         | 用多列显示所有指定文件              |
| -p         | 在每页末暂停，并响铃                |
| -character | 用单个指定的字符分割列。默认是[tab] |
| -t         | 取消5行页眉和5行页脚                |
| -w number  | 用指定字符数设置行宽。默认值为72    |

## 第六章 vim高级应用

### 多文件编辑（tab）

使用`:tabnew`创建新tab，`:e`打开文件，`:tabnext`进入下一个tab，`:tabprevious`进入前一个tab，`:q`或`:tabclose`关闭tab

### 寄存器

在命令模式中，使用双引号开头引用寄存器

`:reg`显示寄存器

寄存器分类：

- 有名寄存器a-z，供用户使用
- 编号寄存器0-9，vim自己使用，存放删除和拷贝的文本
  - "0寄存器保存拷贝的内容（visual和yank）
  - "1-"9寄存器保存删除的内容（dd）
- 缺省寄存器
  - %：当前窗口对应的文件名
  - #：当前窗口的其它文件名
  - :：命令行模式最近输入的命令
  - .：最近插入的文本
  - "：最近删除或拷贝的文本

在使用删除和复制命令前先指定寄存器，就可以把内容保存到寄存器中

### Motion与Range

motion指的是移动光标的命令

复制和删除命令可以与motion结合

- 命令=操作符+motion

| motion | 功能         |
| ------ | ------------ |
| $      | 从光标到行尾 |
| 0      | 从光标到行首 |
| e或w   | 从光标到字尾 |
| b      | 从光标到字首 |

range指的是行数

寄存器+[range]+d/y+[motion]组合，完成复制和删除动作

### 定制vim

修改主目录的`.vimrc`文件

set命令：

- :set all显示所有选项
- :set显示被修改的选项
- :set X?显示选项X的值

### 运行shell命令

`:shell`切换到shell，exit回到vim

`:!命令`，执行shell的命令

`:r!命令`，将shell的输出粘贴到当前位置

`:0r!命令`，将shell的输出粘贴到文件开头

### 缩写与宏

在命令行模式中，可以定义文本的缩写

```shell
# 定义UNIX Operating System的缩写为uno
# 通过uno前后的空格进行识别
:ab uno UNIX Operating System
# 取消缩写
:unab uno
# 显示当前有哪些缩写
:ab
```

宏操作符（map）可以将一系列键指定给某个键（命令模式下）

```shell
# 将q映射为5dd
# F1~F12用#1~#12表示
:map q 5dd
# 取消映射
:unmap q
```

## 第七章 正则表达式

RE可分为BRE和ERE，这里主要介绍BRE

### RE字符集

RE将字符划分为普通字符和元字符

特殊字符及其含义:arrow_down:：

| 字符      | BRE/ERE | 含义                                                         |
| --------- | ------- | ------------------------------------------------------------ |
| \         | Both    | 转义                                                         |
| .         | Both    | 匹配单个字符                                                 |
| *         | Both    | 匹配任意次，可以是0次                                        |
| ^         | Both    | 从行首开始匹配                                               |
| $         | Both    | 从行尾开始匹配                                               |
| [...]     | Both    | 匹配括号内任意字符，x-y表示范围，\[^...\]表示不匹配括号内任何字符 |
| \\{n,m\\} | BRE     | 匹配次数为[n,m]                                              |
| \\(\\)    | BRE     | 定义一个匹配位置，在后面可以引用（\1,\2,\3等）               |
| \n        | BRE     | 引用已经定义的位置，可以从\1到\9                             |

下面这些是ERE的：

| 字符  | 含义                     |
| ----- | ------------------------ |
| {n,m} | 与BRE的\\{n,m\\}含义相同 |
| +     | 至少匹配一次             |
| ?     | 匹配0或1次               |
| \|    | 或                       |
| ()    | 匹配括号内的整个字符串   |

### 特殊的[...]表达式

- [[:alnum:]]字符+数字
- [[:alpha:]]字符
- [[:digit:]]数字
- [[:lower:]]小写字符
- [[:upper:]]大写字符
- [[:space:]]空字符：空格、tab等
- [0-9]匹配0～9中的任意一个
- [a-z]匹配a～z中的任意一个
- ……

### vim的正则表达式

首先启用magic：`:set magic`

在查询命令`/`或`?`后跟一个RE

vim的替换：

- :range s/from/to/flags
  - range表示行范围，当其为`%`时表示所有行，1,$表示从1行到尾行
  - flags为g时表示一行中的所有匹配项都替换
- 常用：:%s/from/to/g

## 第八章 UNIX文件系统（续）

### 重定向

- 标准输入（stdin）：代码为0，使用<或<<
  - command < file
  - command << EOF 当碰到EOF时，输入结束
- 标准输出（stdout）：代码为1，使用>或>>
  - command > file
  - command >> file 追加
- 标准错误输出（stderr）：代码为2，使用2>或2>>
  - command 2> file
  - command 2>> file 追加
- 标准输出+标准错误输出：\$>或\$>>
  - command $> file
  - command $>> file 追加

不需要的数据重定向到`/dev/null`（黑洞装置，bit垃圾桶）

### 管道

将一个程序的标准输出作为另一个程序的标准输入

```shell
command A | command B
# examples
ls -al | grep -e '^d'
ls | xargs wc -l
```

#### tee

`tee`命令可以分离输出，同时输出到标准输出和文件

| 选项 | 功能         |
| ---- | ------------ |
| -a   | 追加到文件   |
| -i   | 忽略中断信号 |

### 文件操作

#### wc统计字数

| 短选项 | 长选项  | 功能       |
| ------ | ------- | ---------- |
| -l     | --lines | 统计行数   |
| -w     | --words | 统计单词数 |
| -c     | --chars | 统计字符数 |
|        | --help  | 帮助       |

#### head显示文件头部

默认显示前10行

| 短选项 | 长选项    | 功能            |
| ------ | --------- | --------------- |
| -n     | --lines=n | 显示头部n行     |
| -c n   | --chars=n | 显示头部n个字符 |
|        | --help    | 帮助            |
|        | --version | 版本号          |

#### tail显示文件尾部

默认显示尾部10行

| 短选项 | 长选项    | 功能            |
| ------ | --------- | --------------- |
| -n     | --lines=n | 显示尾部n行     |
| -c n   | --chars=n | 显示尾部n个字符 |
|        | --help    | 帮助            |
|        | --version | 版本号          |

#### cut纵向输出文件的列

| 短选项  | 长选项            | 功能               |
| ------- | ----------------- | ------------------ |
| -f LIST | --fields=LIST     | 指定剪切的域       |
| -d x    | --delimiter=x     | 指定域的分隔符     |
| -c LIST | --characters=LIST | 指定剪切的字符位置 |
|         | --help            | 帮助               |

域的表示：

- n-m表示[n,m]的域
- n,m表示n和m的域

默认分隔符是tab键

#### paste横向连接两个文件

默认分隔符为tab键

| 短选项 | 长选项         | 功能           |
| ------ | -------------- | -------------- |
| -d x   | --delimiters=x | 指定域的分隔符 |

#### 显示文件

more可以后翻，不能前翻

less可以前后翻

#### sort

排序，按照行做字典序排列文件内容

| 选项 | 功能                                 |
| ---- | ------------------------------------ |
| -b   | 忽略行首空格                         |
| -d   | 在字典序比较中忽略标点符号和控制符号 |
| -t   | 指定域分隔符                         |
| -n   | 数字以数值排序                       |
| -r   | 逆序排列                             |
| -o   | 指定输出文件                         |

字典序排列中，大写字母在小写字母之前

#### grep

grep命令打开文件，在文件中以RE的方式搜索字符串

- grep [option...] patterns [file...]

| 短选项      | 长选项            | 功能             |
| ----------- | ----------------- | ---------------- |
| -c          | --count           | 只显示匹配的行数 |
| -i          | --ignore-case     | 忽略大小写       |
| -G          | --basic-regexp    | BRE，grep默认    |
| -E          | --extended-regexp | ERE，egrep默认   |
| -e PATTERNS | --regexp=PATTERNS | 指定一个或多个RE |
| -v          | --invert-match    | 显示不匹配的行   |
| -n          | --line-number     | 输出行号         |

#### xargs

```shell
xargs [command [initial-arguments]]
```

从标准输入上读，将标准输入文件按照空格/tab拆解成参数，作为command执行的参数（多用于管道命令）

### 文件系统原理

三大抽象：

- 进程、线程对执行过程
- 文件对io
- 地址空间对内存

四种io：

- 文件系统
- 块设备
- 字符设备
- socket

#### UNIX磁盘结构

UNIX里，磁盘是一个标准块设备，一个UNIX磁盘被划分成四个块（区域）：

- 主引导块（boot block）
- 超级块（super block）
- i节点列表块（i-node list block）
- 文件和目录块

**主引导块：**主引导块保存引导程序，系统启动时激活

**超级块：**超级块包含磁盘自身的信息，包括：

- 磁盘的总块数
- 空闲块数
- 块大小（按字节大小计算）
- 使用的块数

**i节点列表块：**列表的每个条目是一个64字节存储区的i节点。规则文件或目录文件的i节点包含所在磁盘块的信息，特殊文件的i节点包含确定外围设备的信息。i节点还包含如下信息：

- 文件访问权限（rwx）
- 所有者与组id
- 文件链接数
- 文件最后修改时间
- 最后访问时间
- 每个规则文件或目录文件的块位置
- 特殊文件的设备id号

i节点是顺序计算的

#### ln链接

ln命令用于建立文件之间的链接

- ln [option] ... [-T] TARGET LINK_NAME
- ln命令不会创建新的i-node，而是引用已有的i-node，增加引用次数
- ln -s建立符号链接，分配新的i-node，内部记录指向原文件

#### df (disk free)

显示未用磁盘空间

#### du (disk usage)

显示文件系统中每个目录和文件占用的存储块数目

| 选项 | 功能                                         |
| ---- | -------------------------------------------- |
| -a   | 显示目录和文件的大小                         |
| -s   | 只显示指定目录占用的存储块数目，不列出子目录 |

## 第九章 Shell编程

```python
# 打开shell命令解析的调试模式
set -vx
# 关闭调试模式
set +vx
```

### 元字符

shell路径元字符：

- 元字符**不是**正则表达式

元字符及其含义：

|元字符|功能|
|---|---|
|?|匹配路径名的单个字符|
|*|匹配任意多个字符|
|\[list\]|匹配list中的任意字符（可以用-表示区间）|
|\[!list\]|匹配list以外的任意字符（可以用-表示区间）|

双引号字符串会展开$VAR变量

单引号字符串不会展开$VAR变量

重音符号表示内嵌命令，先执行，得到输出作为参数

相关的连续命令（可参考C/C++中的逻辑表达式截断）：

- cmd1 && cmd2：cmd1正确运行结束后才运行cmd2
- cmd1 || cmd2：cmd1运行错误才运行cmd2

### find命令

在文件目录树中查找文件

- find start-point tests action
  - 从start-point（路径）开始查找
  - 满足tests的测试则执行action

测试条件

| 选项           | 功能                            |
| -------------- | ------------------------------- |
| -name filename | 匹配文件名                      |
| -size +-n      | 查找大小为n的文件               |
| -type filetype | 查找指定文件类型的文件          |
| -atime n       | 查找最近访问时间在n天之前的文件 |
| -mtime n       | 查找最近修改时间在n天之前的文件 |

Action选项

| 选项             | 功能                 |
| ---------------- | -------------------- |
| -print           | 打印输出             |
| -exec command \; | 执行命令             |
| -ok command \;   | 在执行命令前要求确认 |

### 进程管理

#### ps

显示进程

| 选项 | 功能                                             |
| ---- | ------------------------------------------------ |
| -a   | 显示所有进程，不包括会话leader，不包括无终端进程 |
| -f   | 显示进程完整信息                                 |
| -e   | 显示所有进程                                     |
| -H   | 按照树形显示                                     |
| -j   | 按照job形式输出                                  |

#### kill

向进程发送信号，默认发送SIGTERM信号，代码15

| 选项   | 功能                                     |
| ------ | ---------------------------------------- |
| -l     | 列出所有信号（64个）                     |
| -1     | 除int进程和自己以外的所有进程            |
| -s     | 发送s标志的信号                          |
| -n PID | 给进程号为PID的程序发送编号为n的中断信号 |

kill发送的信号类似于硬件中断

- ctrl+c发送SIGINT
- ctrl+d发送EOF

在unix系统中，信号被设计为“软中断”

进程类比于一个程序，信号从各个侧面完整地模拟中断机制

#### trap

设置进程捕获信号后如何处理

- trap "command" signal numbers
- trap "" TERM 忽略SIGTERM信号
- trap - TERM 恢复SIGTERM信号的缺省处理

| 信号数 | 信号名 | 含义             |
| ------ | ------ | ---------------- |
| 1      | 挂起   | 失去终端联系     |
| 2      | 中断   | 任一中断键被按下 |
| 3      | 退出   | 任一退出键被按下 |
| 9      | 杀死   | 发出kill -9命令  |
| 15     | 终止   | 发出kill命令     |

### 前台后台

在shell中，可以使用&表示后台执行：

- command &

使用`jobs`命令查看后台执行的任务（SHELL BUILTIN COMMANDS）

`fg`命令可以将后台命令调回前台

```shell
(base) jefffu@jefffu-PC:~$ sleep 30 &
[1] 17255
(base) jefffu@jefffu-PC:~$ jobs
[1]+  运行中               sleep 30 &
(base) jefffu@jefffu-PC:~$ fg 1
sleep 30
^C
(base) jefffu@jefffu-PC:~$ 
```

`nohup`命令可以使后台执行的命令在登出后保持执行

- nohup "command" &

### history

bash在执行命令后，将历史命令保存在内存中

用户登出时，将历史命令写入到`.bash_history`文件中

使用`history`命令可以列出历史命令

使用`fc`命令可以编辑历史命令的序列并执行

- fc first last 先编辑从first到last的命令，然后执行
- fc -s number 执行编号为number的历史命令

### 脚本

shell是一种语言，unix提供基本功能，用户自行扩展，包括shell脚本

#### 自包含脚本文件

- 文件开头：#! /bin/bash
- 修改为可执行文件：chmod +x

#### 脚本调试

##### echo

输出参数

- echo "hello, world"
- echo $tmp

##### set -x

打开执行命令输出（输出带参数展开后的命令）

`set +x`关闭

##### set -v

输出参数替换前的命令

`set -v`关闭

##### sh

sh可以在执行脚本时添加一些选项

| 选项 | 功能                                   |
| ---- | -------------------------------------- |
| -n   | 读取命令但不执行（可用于查找语法错误） |
| -v   | 显示变量替换前的命令                   |
| -x   | 执行命令时显示命令的参数（变量替换后） |

#### 变量

在变量名的前面加上$符号来获取变量的内容，变量的设置可以用“变量名=变量值”的形式，但是等号两边不能有多余的空格。设置变量的内容也可以引用已有的变量，或者在已有的变量后加入新内容，如：

```shell
var=haha
echo $var   #haha
var="$var"haha
echo $var   #hahahaha
```

关于变量设置的命令

| 命令   | 功能                                         |
| ------ | -------------------------------------------- |
| echo   | 用来显示变量的值（其实跟变量没有什么关系）   |
| export | 将变量设置为环境变量（使得子程序也可以使用） |
| env    | environment，显示所有环境变量                |
| set    | 显示所有变量                                 |
| unset  | 删除某变量                                   |

一些常见（常用）变量及其含义

| 变量名 | 含义                                                         |
| ------ | ------------------------------------------------------------ |
| $      | $本身也是变量，表示当前这个bash的PID                         |
| ?      | 前一个程序运行的返回值                                       |
| HOME   | 家目录                                                       |
| SHELL  | 使用的shell，一般是/bin/bash                                 |
| RANDOM | 生成0~32767之间的随机数                                      |
| IFS    | 内部字段分隔符                                               |
| PATH   | shell在定位命令和程序时所需要查找的目录名，用冒号分隔多个路径 |
| PS1    | 设置用户命令提示符字符串                                     |

##### 变量替换操作

| 替换操作        | 功能                                                   |
| --------------- | ------------------------------------------------------ |
| ${VAR:-word}    | 如果变量不存在，返回word                               |
| ${VAR:=word}    | 如果变量不存在，设置VAR为word，返回word                |
| ${VAR:?message} | 如果变量不存在，打印message，退出，但交互shell不会退出 |
| ${VAR:+word}    | 如果变量存在，返回word，否则返回null                   |

##### 位置参数

一组特殊的变量，用于表示命令行参数

| 变量         | 含义                                 |
| ------------ | ------------------------------------ |
| $1-$9, ${10} | 参数                                 |
| $0           | 命令名                               |
| $#           | 参数个数                             |
| $*           | 将所有参数使用$IFS隔开，形成的字符串 |
| $@           | 每一个参数一行                       |
| set（命令）  | 用于改变命令行参数                   |

#### 算术表达式

计算算术的时候使用`$(())`作为算术表达式

算术运算符：++, --, +, -, !, ~, \*, /, %等

在算术表达式中，true=1，false=0

shell script中可以用`read`命令进行变量值的输入。

```shell
read -p "pleas input the value:" -t 30 var
```

上述命令在屏幕显示提示信息，等待输入30秒。

`declare [-axirp] var`用于声明变量属性（默认字符串类型）：

- -a array
- -i integer
- -x 相当于export
- -r readonly（不能unset）
- -p 显示变量属性

数值计算默认为整型，将"-"改为"+"可以取消操作。

更改文件系统和程序的限制关系：`ulimit`（user limit）限制打开文件数量，CPU时间，运存等。

`alias`和`unalias`定义和取消命令别名。

#### shell script

通配符及其含义

| 符号 | 含义                               |
| ---- | ---------------------------------- |
| *    | 0个及以上任意字符                  |
| ?    | 至少一个任意字符                   |
| []   | 至少一个括号内的字符               |
| [-]  | -表示编码顺序的所有字符，如0-9     |
| [^]  | 反向选择，至少一个不是括号里的字符 |

#### 条件分支

```shell
if 条件; then
		command lines
[elif 条件
		command lines]
[else
		command lines]
fi
```

条件是一段命令，测试的是$?是否为0

`test EXPRESSION`测试条件

##### 字符串测试

| 操作府 | 说明             |
| ------ | ---------------- |
| =      | 两字符串是否相同 |
| !=     | 两字符串是否不同 |
| -n     | 字符串不是null   |
| -z     | 字符串是null     |

引用变量做字符串测试时，需要加双引号

操作符两侧必须有空格

[ ... ]中括号必须有空格

##### 文件测试

| 操作符 | 含义                  |
| ------ | --------------------- |
| -r     | 文件是否可读          |
| -w     | 文件是否可写          |
| -s     | 文件是否存在且长度非0 |
| -f     | 文件是否是普通文件    |
| -d     | 文件是否是目录文件    |

##### 算术表达式测试

- 使用`$(())`计算算术表达式
- 利用字符串进行比较

#### 选择分支（case）

```shell
case $VAR in
		case1)
				...;;
		case2)
				...;;
		......
		*)
				...;;
esac
```

#### 循环

Shell提供三种循环：for、while、until

##### for

```shell
for variable in list-of-values; do
		...
done
# list-of-values使用$IFS隔开，缺省是空格、tab、回车

# 枚举所有参数
for i; do
		...
done
```

##### while

```shell
while [ condition ]; do
		...
done
# [ condition ]等价于前面的test命令
```

##### until

```shell
until [ conditioin ]; do
		...
done
# 条件为真时，结束循环
```

#### 函数

```shell
# 函数定义
[function] funname()
{
		...
		[return n]
}
```

函数的引用类似于普通命令，而函数的执行类似于内置命令，不会fork新的shell

#### 终端命令

##### stty

设定终端模式

- stty -echo 禁止回显
- stty echo 打开回显

| 选项         | 功能                                    |
| ------------ | --------------------------------------- |
| echo [-echo] | 回显[不回显]输入字符，默认回显          |
| raw [-raw]   | 禁止[启用]特殊意义字符，默认启用        |
| intr         | 生成中断信号，通常用Del键（？）         |
| erase        | （回退）擦出前一个字符，通常用#键（？） |
| kill         | 删除整行，通常用@或Ctrl-u键             |
| eof          | 从终端产生eof信号，通常用Ctrl-d键       |
| ek           | 用#和@分别复位erase和kill键             |
| sane         | 用合理的默认值设置终端属性              |

##### tput

控制终端输出缓冲

- tput clear 清屏
- tput cup row collum 移动光标到row行column列

| 选项    | 功能                     |
| ------- | ------------------------ |
| bel     | 回显终端的响铃字符       |
| blink   | 闪烁显示                 |
| bold    | 粗体显示                 |
| clear   | 清屏                     |
| cup r c | 将光标移动到r行c列       |
| dim     | 显示变暗                 |
| ed      | 从光标位置到屏幕底清屏   |
| el      | 从光标位置到行末清除字符 |
| smso    | 启动突出模式             |
| rmso    | 结束突出模式             |
| smul    | 启动下划线模式           |
| rmul    | 结束下划线模式           |
| rev     | 反白显示                 |
| sgr0    | 关闭所有属性             |

#### 其它命令

`.command`命令执行command，但是不会fork新进程

`printf`命令兼容所有shell，命令方式与C类似

```shell
cnt=3
printf "cnt=%d\n" $cnt
```

`df`显示可用空间

`du`统计文件或者目录的磁盘使用情况

##### tar

- zcfv压缩成.tar.gz文件
- zxfv解压.tar.gz文件
- Jcfv压缩成.tar.xz文件
- Jxfv解压.tar.xz文件
- jcfv压缩成.tar.bz2文件
- jxfv解压.tar.bz2文件

更详细的tar命令参数：

| 选项 | 功能                                                      |
| ---- | --------------------------------------------------------- |
| c    | （create）创建一个新的存档文件，该文件原来的内容被覆盖    |
| r    | （replace）添加文件到存档文件中，该文件中原来的内容保留   |
| t    | （table of contents）列出存档文件中所有被打包文件的文件名 |
| x    | （extract）从存档文件中提取被打包的文件                   |
| f    | （file）用下一个参数作为存档文件的存放位置                |
| v    | （verbose）显示详细打包过程信息                           |

##### chmod

修改文件访问权限

```shell
chmod [ugoa][+-=]rwx
```

`chown`修改owner

`chgrp`修改group

##### eval

重新解析表达式

```shell
# 编写脚本，输入变量名，输出变量的值
eval echo \$$1
```

`$()`等价于重音符号\`\`

##### type

查询命令的类型（内建命令还是外部命令）

##### time

得到用户执行程序的时间信息，包括实际时间，用户时间和系统时间

- 实际时间：从用户输入命令行的回车键开始到命令执行完毕
- 用户时间：用于执行用户命令中用户代码的CPU时间
- 系统时间：为了完成用户命令而执行UNIX系统例程的时间

## GNU工具链

开发操作系统、应用程序的一套完整的程序和库，包括gcc、gdb、glibc

### gcc

一族编译器（不仅仅是C），包括C、C++、go、java等

#### C语言编译过程

```shell
gcc -E hello.c -o hello.i
gcc -S hello.i -o hello.s
gcc -c hello.s -o hello.o
gcc -o hello hello.o
```

文件后缀名及其含义：

| 后缀名      | 含义                           |
| ----------- | ------------------------------ |
| .c          | C语言源代码文件                |
| .a          | 由目标文件构成的档案库文件     |
| .C .cc .cxx | C++源代码文件                  |
| .h          | 头文件                         |
| .i          | 已经预处理过的C源代码文件      |
| .ii         | 已经预处理过的C++源代码文件    |
| .m          | Objective-C源代码文件          |
| .o          | 编译后的目标文件               |
| .s          | 汇编语言源代码文件             |
| .S          | 经过预编译的汇编语言源代码文件 |

### gdb

gdb是命令行下的调试程序，常见命令如下：

| 命令                     | 缩写 | 描述             |
| ------------------------ | ---- | ---------------- |
| list                     | l    | 打印当前位置源码 |
| break                    | b    | 设置断点         |
| run                      | r    | 运行程序         |
| step                     | s    | 单步，进入函数   |
| next                     | n    | 单步，不进入函数 |
| print                    | p    | 打印变量         |
| continue                 | c    | 继续运行         |
| backtrace                | bt   | 显示调用栈       |
| info threads             |      | 显示线程         |
| thread n                 |      | 切换线程         |
| set scheduler-locking on |      | 关闭线程调度     |

### Makefile

Makefile常用于工程的组织和编译，是一种依赖推导语言

变量定义+依赖描述

```makefile
target: dependencies, ...
		actions
```

显式规则和隐式规则

```makefile
%o: %c
		$(COMILE..c) $(OUTPUT_OPTION) $<
```

推导规则

- 检查目标和依赖文件的时间，如果依赖发生更新，则执行动作
- 显式规则 > 隐式规则

推导过程

- 动态规划
- 从target出发，枚举所有规则，直到依赖可达

### cmake

Cmake的语法采用命令式，跨平台，可以导出为makefile、sln等

Cmake在不同平台上生成不同的本地化脚本：

| 平台          | 脚本         |
| ------------- | ------------ |
| Linux         | Gnu Makefile |
| Visual Studio | sln          |
| Google        | ninja        |

编译过程：

1. cmake生成本地编译脚本
2. 使用本地编译脚本编译程序

### git

版本控制系统（Version Control System，VCS）

- 本地版本控制
- 集中化版本控制
- 分布式版本控制

主要命令：

- git init
- git clone
- git status
- git add
- git commit
- git log
- git fetch [remote-name]
- git push [remote-name] [branch-name]
- git branch